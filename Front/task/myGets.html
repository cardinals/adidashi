<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/iconfont.css" />
		<link rel="stylesheet" href="../css/myGets.css" />
		<script src="../js/mui.min.js"></script>
	</head>
<!--我领取的-->
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon iconfont icon-left"></a>
			<h1 class="mui-title">我领取的</h1>
		</header>
		<div class="mui-content">
			<div class="mui-row">
				<div class="mui-col-sm-12 mui-col-xs-12 publisherArea">
					<div>
						<img src="../logo/logo.png" />
					</div>
					<div>
						<h4 id="wating">待确认</h4>
						<h4 id="performer"></h4>
						<h4>手机：<span id="performerMobile"></span></h4>
						<div>
							<div>
								<i class="mui-icon iconfont icon-shimingrenzheng"></i>
							</div>
							<div>
								<i>认证</i>
							</div>
						</div>
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12 des">
					<div style="width: 100%; background-color: #FFFFFF;">
						<div class="taskDetails" align="left">
							<span style="font-weight: bold;">任务详情&nbsp;:&nbsp;</span><span id="myGetTaskDetails"></span><br />
							<span style="font-weight: bold;">开始时间&nbsp;:&nbsp;</span><span id="myGetTaskStratTime"></span><br />
							<span style="font-weight: bold;">截止时间&nbsp;:&nbsp;</span><span id="myGetTaskEndTime"></span><br />
							<span style="font-weight: bold;">联系方式&nbsp;:&nbsp;</span><span id="myGetTaskContactType"></span><br />
							<span style="font-weight: bold;">领取地点&nbsp;:&nbsp;</span><span id="myGetTaskGetPlace"></span><br />
							<span style="font-weight: bold;">交接地点&nbsp;:&nbsp;</span><span id="myGetTaskJoinPlace"></span><br />
						</div>
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12 taskdetails">
					<div align="center">
						<h3 id="taskMoney"></h3>
						<span>任务悬赏金额(元)</span>
					</div>
					<div align="center">
						<h3>29:59:00</h3>
						<span>任务剩余时间</span>
					</div>
					<div align="center">
						<h3>00:00:00</h3>
						<span>任务延迟时间</span>
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12 taskBtns" align="center">
					<div class="mui-content-padded">
						<button type="button" class="mui-btn mui-btn-danger" id="confrimComplete">确认完成</button>
						<button type="button" class="mui-btn mui-btn-warning" id="cancel">发起取消</button>
						<button type="button" class="mui-btn mui-btn-success" id="complete">已完成</button>
					</div>
				</div>
				<span id="tsid" style="display: none;"></span>
				<span id="tstype" style="display: none;"></span>
				<span id="balance" style="display: none;"></span>
				<!--<span id="getter" style="display: none;"></span>-->
			</div>
		</div>
		<script type="text/javascript">
			mui.init();
			var json = "";
			var getter = "";
			mui.plusReady(function(){
				window.addEventListener('refresh', function(e) { //执行刷新
					location.reload();
				});
				window.self = plus.webview.currentWebview();
				window.id = self.gid;
				document.getElementById("tsid").textContent = id;
				plus.nativeUI.showWaiting('玩命加载中...');
				mui.ajax({
					url:'http://47.96.156.75/public/index/task/gettaskinfo',
					dataType:'json',
					type:'post',
					async:false,
					data:{id:id},
					header:{'Conetnt-Type':'application/json'},
					success:function(data){
						json = JSON.parse(data);
						getter = json.task_user;
						if(json.task_complete == '是'){
							document.getElementById("complete").style.display = "block";
						} else{
							document.getElementById("complete").style.display = "none";
							document.getElementById("confrimComplete").style.display = "block";
							document.getElementById("cancel").style.display = "block";
							document.getElementById("wating").textContent = '已完成';
						}
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常：'+type);
					}
				});
				mui.ajax({
					url:'http://47.96.156.75/public/index/task/gettaskinfo',
					dataType:'json',
					type:'post',
					async:false,
					data:{id:id},
					header:{'Conetnt-Type':'application/json'},
					success:function(data){
						json = JSON.parse(data);
						document.getElementById("performer").textContent = '执行者:'+json.task_get_user;
						document.getElementById("tstype").textContent =json.task_title;
						document.getElementById("performerMobile").textContent = json.task_get_user;
						document.getElementById("myGetTaskDetails").textContent = json.task_details;
						document.getElementById("myGetTaskStratTime").textContent = json.task_start_time;
						document.getElementById("myGetTaskEndTime").textContent = json.task_end_time;
						document.getElementById("myGetTaskContactType").innerHTML = json.task_user+"<i class='mui-icon iconfont icon-dianhua' style='font-size: 1.2rem; color: #FF0000;'></i><i style='font-style: normal; font-size: 0.78rem; color: #FF0000;' id='callPhone'>拨打电话</i>";
						document.getElementById("myGetTaskGetPlace").innerHTML = json.task_get_location+'<i class="mui-icon iconfont icon-position" style="font-size: 1.2rem; color: #FF0000;"></i><i style="font-style: normal; color: #FF0000;">查看定位</i>';
						document.getElementById("myGetTaskJoinPlace").innerHTML = json.task_connet_location+'<i class="mui-icon iconfont icon-position" style="font-size: 1.2rem; color: #FF0000;"></i><i style="font-style: normal; color: #FF0000;">查看定位</i>';
						document.getElementById("taskMoney").textContent = json.task_money;
						//document.getElementById("getter").textContent = json.task_get_user;
						plus.nativeUI.closeWaiting();
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常：'+type);
					}
				});
				queryAccount();
				//拨打电话
				document.getElementById("callPhone").addEventListener("tap",function(){
					plus.device.dial(document.getElementById("myGetTaskContactType").textContent,false);
				});
				document.getElementById("confrimComplete").addEventListener("tap",function(){
					//var id = document.getElementById("performer").textContent;
					var money = document.getElementById("taskMoney").textContent;
					//var ids = id.split(":")[1];
					getTaskMoney(money);
				});
			});
			
			//将金钱存入个人账户
			function getTaskMoney(money){
				var d = document.getElementById("performerMobile").textContent;
				plus.nativeUI.showWaiting('确认完成中...');
				var b = parseInt(document.getElementById("balance").textContent);
				var m = parseInt(money)+b;
				mui.ajax({
					url:'http://47.96.156.75/public/index/account/gettaskmoney',
					type:'post',
					data:{
						tasker:d,
						taskmoney:m
					},
					dataType:'json',
					header:{'Conetnt-Type':'application/json'},
					async:false,
					success:function(msg){
						json = JSON.parse(msg);
						if(json == 1){
							var s = document.getElementById("tsid").textContent;
							//添加记录
							//获取时间
							var date = new Date();
							var seperator1 = "-";
							var seperator2 = ":";
							var month = date.getMonth() + 1;
							var strDate = date.getDate();
							if (month >= 1 && month <= 9) {
								month = "0" + month;
							}
							if (strDate >= 0 && strDate <= 9) {
								strDate = "0" + strDate;
							}
							var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
								 + " " + date.getHours() + seperator2 + date.getMinutes()
								+ seperator2 + date.getSeconds();
							mui.ajax({
								url:'http://47.96.156.75/public/index/incomeoutlog/addincome',
								type:'post',
								data:{
									users:d,
									money:parseInt(money),
									des:'来自'+document.getElementById("tstype").textContent+'任务',
									time:currentdate,
									type:1,
									form:getter									
								},
								dataType:'json',
								header:{'Conetnt-Type':'application/json'},
								async:false,
								success:function(msg){
									var json = JSON.parse(msg);
									if(json == 1){
										changeTaskState(s);
									} else{
										mui.toast('领取失败');
									}
								},
								error:function(xhr,type,errorThrown){
									mui.toast('异常:'+type);
								}
							});
						}
						plus.nativeUI.closeWaiting();
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常:'+type);
						plus.nativeUI.closeWaiting();
					}
				});
			}
			//改变任务领取状态
			function changeTaskState(id){
				mui.ajax({
					url:'http://47.96.156.75/public/index/task/completetask',
					dataType:'json',
					type:'post',
					async:false,
					data:{tid:id},
					header:{'Conetnt-Type':'application/json'},
					success:function(data){
						json = JSON.parse(data);
						if(json == 1){
							mui.openWindow({
							url:'myGet.html',
							id:'myGet',
							extras:
							{
								taskId:document.getElementById("tsid").textContent
							}
						});
						}
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常：'+type);
					}
				});
			}
			function queryAccount(){
				//查询余额
				mui.ajax({
					url:'http://47.96.156.75/public/index/account/queryinout',
					type:'post',
					data:{phone:document.getElementById("performerMobile").textContent},
					dataType:'json',
					async:false,
					header:{'Conetnt-Type':'application/json'},
					success:function(data){
						account = JSON.parse(data);
						if(account[0].allmoney < 1){
							document.getElementById("balance").textContent = 0;
						} else{
							document.getElementById("balance").textContent = account[0].allmoney;
						}
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常:'+type);
					}
				});
			}
		</script>
	</body>

</html>