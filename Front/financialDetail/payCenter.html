<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/iconfont.css" />
		<link rel="stylesheet" href="../css/payCenter.css" />
		<script src="../js/jquery.2.1.1.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<!--<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>-->
		<script type="text/javascript" src="../js/wang_payment.min.js" ></script>
		<style>
			.button{
				border: none;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon iconfont icon-left"></a>
			<span class="mui-title">充值</span><i id="accountDetailBtn">账户明细</i>
		</header>
		<div class="mui-content">
			<div class="mui-row" style="background: #F1F1F1;">
				<div class="mui-col-sm-12 mui-col-xs-12 payArea">
					<div align="center">
						<h3 id="payMoney">0</h3>
						<span>充值金额（元）</span>
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12 selectPayMoney" style="margin-top: 10%;">
					<button value="10" class="button" >10元</button>
					<button value="20" class="button">20元</button>
					<button value="30" class="button">30元</button>
					<button value="50" class="button">50元</button>
					<button value="100" class="button">100元</button>
					<button value="200" class="button">200元</button>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12" style="margin-top: 50%;">
					<div class="mui-content-padded" align="center">
						<button type="button" class="mui-btn mui-btn-danger" id="btnPayMoney">充值</button>
					</div>
					<div id="confirmPay" align="center" class="mui-col-sm-12 mui-col-xs-12 box mui-popover mui-popover-action mui-popover-bottom" style="background: #FFFffF;">
						<div>
							<i class="mui-icon mui-icon-closeempty" id="closeConfirmPay"></i><span>付款详情</span>
						</div>
						<div style="display: none;">
							<i>订单号</i><span >SDsd132456576788</span>
						</div>
						<div style="display :none;">
							<i>商户号</i><span>1234567890</span>
						</div>
						<div>
							<i>订单价</i><span id="confirmPayMoney"></span>
						</div>
						<div>
							<span>选择付款方式</span>
						</div>
						<div>
							<div>
								<i class="mui-icon iconfont icon-yinxingqia"></i><br />
								<span>绑卡支付</span>
							</div>
							<div id="weichat">
								<i class="mui-icon iconfont icon-weixin"></i><br />
								<span>微信</span>
							</div>
							<div id="zhifubaopay">
								<i class="mui-icon iconfont icon-zhifubao"></i><br />
								<span>支付宝</span>
							</div>
						</div>
					</div>
				</div>
				<span style="display: none;" id="balance"></span>
			</div>
		</div>
		<script type="text/javascript">
			mui.init({
				beforeback: function() {
			　　　　 //获得父页面的webview
			        var center = plus.webview.currentWebview().opener();
			　　　　 //触发父页面的自定义事件(refresh),从而进行刷新
			        mui.fire(center, 'refresh');
			        //返回true,继续页面关闭逻辑
			        return true;
			    }
			});
			mui.plusReady(function(){
				var user = localStorage.getItem("user");
				/*给金额绑定事件*/
				mui(".selectPayMoney").on("tap","button",function(){
					
					$(this).addClass("mui-btn-danger").siblings().removeClass("mui-btn-danger");
					
					var moneys = this.getAttribute("value");
					document.getElementById("payMoney").innerText = moneys;
					$(this).borderStyle = "none";
				});
				//查询余额
				mui.ajax({
					url:'http://47.96.156.75/public/index/account/queryaccounts',
					type:'post',
					data:{phone:user},
					dataType:'json',
					async:false,
					header:{'Conetnt-Type':'application/json'},
					success:function(data){
						account = JSON.parse(data);
						if(account[0].allpay == 0 || account[0].allpay == undefined){
							document.getElementById("balance").textContent = 0;
							plus.nativeUI.closeWaiting();
						} else{
							document.getElementById("balance").textContent = account[0].allpay;
							plus.nativeUI.closeWaiting();
						}
					},
					error:function(xhr,type,errorThrown){
						mui.toast('异常:'+type);
					}
				});
				/*点击充值*/
				document.getElementById("btnPayMoney").addEventListener("tap",function(){
					var HOST = 'http://47.96.156.75/index.php';
					var money = document.getElementById("payMoney").textContent;
					if(money.length < 1 || money == 0){
						mui.toast('请选择充值金额');
					} else{
						mui('#confirmPay').popover('toggle',document.getElementById("confirmPay"));
						document.getElementById("confirmPayMoney").innerText = document.getElementById("payMoney").textContent+'元';
						var money = document.getElementById("confirmPayMoney").textContent;
						var moneys = Number(money.split('元')[0]);
						var b = Number(document.getElementById("balance").textContent);
						allmoneys = moneys+b;
						document.getElementById("zhifubaopay").addEventListener("tap",function(){
							var datas = {
								"amount":moneys,
								"goods_name":'充值',
								"goods_num":'1',
								"goods_xq":'支付宝充值'
							};
							var config = {
								"address":HOST,
								"type":'post',
								"paymentMethod":'alipay',
								"data":datas,
								"success":successCallback,
								"error":errorCallback
							};
							var payment = new Payment(config);
							payment.PaymentShow();
							//支付成功回调
							function successCallback(result){
								alert(result);
								d = JSON.parse(result);
								alert(d);
								
								mui.ajax({
								url:'http://47.96.156.75/public/index/account/paymoney',
								type:'post',
								data:{
									payer:user,
									money:allmoneys
								},
								dataType:'json',
								header:{'Conetnt-Type':'application/json'},
								async:false,
								success:function(msg){
									json = JSON.parse(msg);
									if(json == 1){
										mui.toast('充值成功');
										//充值成功，记录充值
										//获取时间
										var date = new Date();
									    var seperator1 = "-";
									    var seperator2 = ":";
									    var month = date.getMonth() + 1;
									    var strDate = date.getDate();
									    if (month >= 1 && month <= 9) {
									        month = "0" + month;
									    }
									    if (strDate >= 0 && strDate <= 9) {
									        strDate = "0" + strDate;
									    }
									    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
									            + " " + date.getHours() + seperator2 + date.getMinutes()
									            + seperator2 + date.getSeconds();
									    mui.ajax({
									    	url:'http://47.96.156.75/public/index/incomeoutlog/addincome',
											type:'post',
											data:{
												users:user,
												money:moneys,
												des:'支付宝充值',
												time:currentdate,
												type:3      	
											},
											dataType:'json',
											header:{'Conetnt-Type':'application/json'},
											async:false,
											success:function(msg){
												var m = JSON.parse(msg);
											},
											error:function(xhr,type,errorThrown){
												mui.toast('异常:'+errorThrown);
											}
									    });
									    //关闭充值框
										mui('#confirmPay').popover('toggle',document.getElementById("confirmPay"));
									}
								},
								error:function(xhr,type,errorThrown){
									mui.toast('异常:'+type);
								}
							});
							}
							//请求接口失败 a,b,c失败原因
							function errorCallback(result){
								location.reload();
								//去掉双引号
								var d=JSON.stringify(result.msg);
								str1 = d.replace("\"","").replace("\"","");
								mui.toast(str1);
							};
						});
					}
				});
				//关闭
				document.getElementById("closeConfirmPay").addEventListener("tap",function(){
					mui('#confirmPay').popover("hide");
				});
				//账户
				document.getElementById("accountDetailBtn").addEventListener("tap",function(){
					mui.openWindow({
						url:'accountDetails.html',
						id:'accountDetails'
					});
				});
			});
		</script>
	</body>

</html>