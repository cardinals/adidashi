<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/iconfont.css" />
		<link rel="stylesheet" href="css/unverified.css" />
		<script src="js/mui.min.js"></script>

	</head>

	<body style="background-color: #EFEFF4;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon iconfont icon-left"></a>
			<h1 class="mui-title">个人认证</h1>
		</header>
		<div class="mui-content">
			<div class="mui-row">
				<div class="mui-col-sm-12 mui-col-xs-12" style="height: auto; ">
					<div class="tips" align="left">
						<span>实名头像</span><i>未认证</i><img id="userHead" src="userImages/th.png" class="mui-pull-right userImageUp" />
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12" style="margin-top: 3px;">
					<div class="tips">
						<span>基本信息</span><i>未认证</i>
					</div>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12" style="background: #FFFFFF; height: auto;">
					<form class="mui-input-group" style="height: auto;">
						<div class="mui-input-row" style="width: 100%; height: auto;">
							<label>姓名</label><br />
						</div>
						<div class="mui-input-row">
							<input type="text" id="name" class="mui-input-clear" style="width: 90%; border: 1px solid #DDDDDD; margin-left: 5%; height: 2.2rem;" />
						</div>
						<div class="mui-input-row" style="width: 100%; height: auto;">
							<label>身份证号</label><br />
						</div>
						<div class="mui-input-row">
							<input type="number" id="idnumber" class="mui-input-clear" style="width: 90%; border: 1px solid #DDDDDD; margin-left: 5%; height: 2.2rem;" />
						</div>
						<div class="mui-input-row" style="width: 100%; height: auto;">
							<label>性别</label><br />
						</div>
						<div class="mui-input-row mui-select" style="width: 90%;">
							<select id="sexs">
								<option>男</option>
								<option>女</option>
							</select>
						</div>
						<div class="mui-input-row" style="width: 100%; height: auto;">
							<label>职业</label><br />
						</div>
						<div class="mui-input-row mui-select" style="width:90%;">
							<select id="zhiye">
							</select>
						</div>

						<div class="mui-input-row" style="height: auto;margin:5%;">
							<img id="idImage" src="userImages/photo1.png" class="idImageUp" style="border: 1px solid #DDDDDD; ; width: 100%; height: 12rem; " />
						</div>
					</form>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12">
					<div class="mui-content-padded" style="margin-left: 5%; font-size: 0.756rem;">
						<span>本人已阅读并同意以下协议</span><br />
						<div class="mui-checkbox mui-left">
							<label> <span id ="Xieyi_pop">《信用分服务协议》</span> </label>
							<input id="xieyi" type="checkbox" checked style="margin-left: -6%;" />
						</div>
						<button id="btnVerify" style=" margin-bottom: 10%;" type="button" class="mui-btn mui-btn-danger">提交认证信息</button>
					</div>
				</div>
				<div id="xieyi_pop" class="mui-popover" style="width: 90%;height: 90%; top: 30%;">
					<div class="mui-row">
						<h4 style="text-align: center;margin: 5%;color: gray; font-size: 0.99rem;font-weight: 200;">协议内容</h4>
						<div class="xieyi-text" id="xieyi_text" style="color: gray;font-size: 0.7rem;margin-bottom: 5%;margin-left: 5%;width:90%;word-break:break-all;height:400px;overflow-y:auto;">
							<span id="xydata"></span>
						</div>
						<button class="mui-btn" id="btn_close" style="margin-left: 40%;margin-bottom: 10%; background-color: #CDCDCD;color: black;">已阅读</button>
					</div>
				</div>

			</div>
		</div>
		</div>
		<script type="text/javascript" charset="UTF-8">
			mui.init({
				beforeback: function() {　　　　 //获得父页面的webview
					var list = plus.webview.currentWebview().opener();　　　　 //触发父页面的自定义事件(refresh),从而进行刷新
					mui.fire(list, 'refresh');
					//返回true,继续页面关闭逻辑
					return true;

				}
			});
			var user = localStorage.getItem("user");
			mui.plusReady(function() {
				//用户头像
				mui("body").on('tap', '.userImageUp', function() {
					images.userImageUp();
				});

				//身份证
				mui("body").on('tap', '.idImageUp', function() {
					ids.idImageUp();
				});
				//提交认证
				document.getElementById("btnVerify").addEventListener("tap", function() {
					checkUser();

				});
			})

			//头像
			var images = null;
			images = {
				userImageUp: function() {
					var m = this;
					plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: [{
								title: "拍照"
							},
							{
								title: "从相册中选择"
							}
						]
					}, function(e) {
						switch(e.index) {
							case 1:
								appendByCamera(); //相机
								break;
							case 2:
								appendByGallery(); //相册
								break;
						}
					});
				}
			}
			//拍照添加文件
			function appendByCamera() {
				plus.camera.getCamera().captureImage(function(e) {
					console.log(e);
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var path = entry.toLocalURL();
						document.getElementById("userHead").src = path;
					}, function(e) {
						mui.toast("读取拍照文件错误", +e.message);
					});
				});
			}
			//从相册选择
			function appendByGallery() {
				plus.gallery.pick(function(path) {
					document.getElementById("userHead").src = path;
				});
			}
			//身份证
			var ids = null;
			ids = {
				idImageUp: function() {
					plus.nativeUI.actionSheet({
						cancel: "取消",
						buttons: [{
								title: "拍照"
							},
							{
								title: "从相册中选择"
							}
						]
					}, function(e) {
						switch(e.index) {
							case 1:
								appendIdByCamera(); //相机
								break;
							case 2:
								appendIdByGallery(); //相册
								break;
						}
					});
				}
			}
			//拍照添加文件
			function appendIdByCamera() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var s = entry.toLocalURL();
						var one = s.lastIndexOf('/') + 1;
						var two = s.lastIndexOf('.');
						var three = s.substring(0, one);
						var four = s.substr(two, 4);
						var all = three + user + four;
						document.getElementById('idImage').setAttribute("src", s);
					}, function(e) {
						mui.toast('读取拍照文件错误:' + e.message);
					});
				}, function(s) {
					mui.toast('异常:' + s);
				});
			}
			//从相册选择
			function appendIdByGallery() {
				plus.gallery.pick(function(path) {
					document.getElementById("idImage").src = path;

				});
			}
			//验证用户输入的数据
			function checkUser() {
				var name = document.getElementById("name").value;
				//职业
				var obj = document.getElementById("zhiye"); //定位id
				var index = obj.selectedIndex; // 选中索引
				var texts = obj.options[index].text; // 选中文本
				//性别
				var sexobj = document.getElementById("sexs"); //定位id
				var sexindex = sexobj.selectedIndex; // 选中索引
				var sexs = sexobj.options[sexindex].text; // 选中文本
				var idnumber = document.getElementById("idnumber").value;
				var realhead = document.getElementById("userHead");
				var idimage = document.getElementById("idImage");
				var checked_xy = document.getElementById("xieyi").checked;
				//身份证验证
				var format = /^(([1][1-5])|([2][1-3])|([3][1-7])|([4][1-6])|([5][0-4])|([6][1-5])|([7][1])|([8][1-2]))\d{4}(([1][9]\d{2})|([2]\d{3}))(([0][1-9])|([1][0-2]))(([0][1-9])|([1-2][0-9])|([3][0-1]))\d{3}[0-9xX]$/;
				if(name.length < 1 && name == '') {
					mui.toast('姓名不能为空!');
					document.getElementById("name").focus();
				} else if(texts.length < 1) {
					mui.toast('职业不能为空');
				} else if(!format.test(idnumber)) {
					mui.toast('身份证号不合法');
				} else if(realhead.getAttribute("src")=='userImages/th.png') {
					mui.toast('还未选择头像');
				} else if(idimage.getAttribute("src")=='userImages/ID.png') {
					mui.toast('请选择身份证正面照片');
				} else if(checked_xy == false) {
					mui.toast('请同意协议内容');
				} else {
					plus.nativeUI.showWaiting('提交中...');
					//服务端接口路径
					var server = "http://47.96.156.75/public/index/user/athentication";
					//获取图片元素
					var image = new Image();
					var images = new Image();
					image.src = document.getElementById(" ").src;
					images.src = document.getElementById("userHead").src;
					var files = image;
					var son = images;
					var task = plus.uploader.createUpload(server, {
							method: "POST"
						},
						function(t, state) { //上传完成
							if(state == 200 && t.state == 4) {
								plus.nativeUI.closeWaiting();
								mui.toast('已上传，请耐心等待...');
								var return_login = mui.back();
								mui.back = function() {
									var login = plus.webview.getWebviewById("myCenter");
									login.reload(true);
									return_login();
								}
							}else{	
								plus.nativeUI.closeWaiting();
								mui.toast('上传数据失败，请稍后重试');	
							}
						}
					);
					//添加其他参数
					task.addData("user", user);
					task.addData("name", name);
					task.addData("zhiye", texts);
					task.addData("idnumber", idnumber);
					task.addData("sex", sexs);
					task.addFile(files.src, {
						key: "idimage"
					});
					task.addFile(son.src, {
						key: 'idhead'
					});
					task.start();
				}
			}

			//点击协议文字出现协议弹窗
			document.getElementById("Xieyi_pop").addEventListener("tap", function() {
				mui("#xieyi_pop").popover("toggle", document.getElementById("xieyi_pop"));
				console.log("点击协议文字出现协议弹窗");
				mui.ajax({
					url: 'http://47.96.156.75/public/index/Description/selectinformation',
					type: 'post',
					dataType: 'json',
					async: false,
					header: {
						'Conetnt-Type': 'application/json'
					},
					timeout: 5000,
					success: function(data) {
						//alert(data);
						d = JSON.parse(data);
						//alert(d.data[0].text_content);
						document.getElementById("xydata").innerHTML = d.data[0].text_content;

					},
					error: function(xhr, type, errorThrown) {
						mui.toast('异常:' + errorThrown);
						plus.nativeUI.closeWaiting();
					}
				});

			});
			//点击已阅读 按钮关闭协议弹窗
			document.getElementById("btn_close").addEventListener("tap", function() {
				mui("#xieyi_pop").popover("toggle", document.getElementById("xieyi_pop"));
				console.log("点击已阅读 按钮关闭协议弹窗");
			});

			document.getElementById("xieyi").addEventListener("tap", function() {
				var us_choise = document.getElementById("xieyi").checked;
				console.log(!us_choise);
				var us_choise_ = !us_choise;
				if(us_choise_ == true) {
					mui.confirm("您已同意协议，可以提交认证信息。");
					console.log("阅读并同意");
				}

			})
			mui.ajax({
				url: 'http://47.96.156.75/public/index/Occupation/selectZhiYe',
				type: 'post',
				dataType: 'json',
				async: false,
				header: {
					'Conetnt-Type': 'application/json'
				},
				timeout: 5000,
				success: function(response) {
					// console.log(response);
					d = JSON.parse(response);
					//console.log(d);
					var zhiyeselect = document.getElementById("zhiye");
					var post_options = [];
					// console.log(response.data.data);
					//这里是请求到的数据
					var datalist = d.data;
					datalist.forEach(function(data) {
						//console.log(data.zhiye);
						post_options.push(data.zhiye);

					})
					//  console.log(post_options);
					var i = [];
					post_options.forEach(function(data) {
						//console.log(data);

						//找到zhiye select 然后把每个data生成一个option 标签添加进select里面
						i[data.id] = document.createElement('option');
						i[data.id].innerHTML = data;
						console.log(i[data.id]);
						zhiyeselect.appendChild(i[data.id]);
						//console.log(i[data.id]);
					})
					console.log(zhiyeselect);
					//console.log(i);
					//console.log(zhiyeselect);
				},

				error: function(e) {
					mui.toast('请求职业数据异常:' + e);
				}
			})
		</script>
	</body>

</html>