<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" href="css/mui.min.css">
	<link rel="stylesheet" href="AliIconFonts/iconfont.css" />
	
	<link rel="stylesheet" href="css/iconfont.css" />

	<link rel="stylesheet" href="css/index.css" />
	<link rel="stylesheet" href="css/liMarquee.css" />
	<script src="js/mui.min.js"></script>
	<!--<script type="text/javascript" src="js/tools/speech.js" ></script>-->
	<script type="text/javascript" src="js/phoneInfo.js" ></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=K74l8tomiD9pkXG0DoRxtG6OENpRlx5c"></script>
	<script type="text/javascript" src="js/convertor.js" ></script>
	<script type="text/javascript" src="js/jquery.2.1.1.min.js" ></script>
	<script type="text/javascript" src="js/tools/jquery.liMarquee.js" ></script>
	<script src="js/axiso.min.js"></script>
	<style type="text/css">
	#allmap img {
		max-width: inherit;
	}
	/*移除底部或顶部三角,需要在删除此代码*/  
    .mui-popover .mui-popover-arrow:after {  
        width: 0px;
    } 
</style>
	<title>无题</title>
</head>
<body>
	<div id="allmap"></div>
	<!--顶部菜单栏-->
	<div class="mui-row topMune" align="center">
		<div class="mui-col-sm-6 mui-col-xs-12">
			<div id="share">
				<i class="mui-icon iconfont icon-fenxiang2"></i>
			</div>
			<div id="gonggao">
				<i class="mui-icon iconfont icon-gonggao"></i>
			</div>
			<div id="taskProgress">
				<i class="mui-icon iconfont icon-renwu"></i>
			</div>
			<div id="taskActivity">
				<i class="mui-icon iconfont icon-activity"></i> 
			</div>
		</div>
	</div>
	<!--最新动态栏-->
	<div class="mui-row news" >
		<div class="mui-col-sm-6 mui-col-xs-12">
			<div class="newContent">
				<div>
					<span>最新动态:</span>
				</div>
				<div id="scroll_div">
				</div>
			</div>
		</div>
	</div>
	<!--右下操作栏-->
	<div class="mui-row options" align="center">
		<div class="mui-col-sm-6 mui-col-xs-12">
			<div id="myHongbao">
				<i class="mui-icon iconfont icon-hongbao"></i>
			</div>
			<div id="inviteFriend">
				<i class="mui-icon iconfont icon-share-friend"></i>
			</div>
		</div>
	</div>
	<!--手动定位-->
	<div class="mui-row handPosition">
		<div class="mui-col-sm-6 mui-col-xs-12" id="handPosition">
			<i class="mui-icon iconfont icon-dingwei"></i>
		</div>
	</div>
	<div class="mui-content">
		<!--菜单开始-->
		<div id="mune-son" class="hide">
			<!--开始-->
			<div>
				<div>
					<i class="mui-icon iconfont icon-user"></i>
				</div>
				<div>
					<button type="button" id="myCenter">个人中心</button>
				</div>
			</div>
			
			<div>
				<div>
					<i class="mui-icon iconfont icon-task_fill"></i>
					
				</div>
				<div>
					<button type="button" id="taskPro">任务进度</button>
				</div>
			</div>
			
			<div>
				<div>
					<i class="mui-icon iconfont icon-daohang1"></i>
				</div>
				<div>
					<button type="button" id="publishTask">发布任务</button>
				</div>
			</div>
			<!--结束-->
		</div>
		<!--菜单结束-->
		<!--按钮-->
		<div>
			<i id="mainBtn" class="mui-icon iconfont icon-jiahao2"></i>
		</div>
	</div>
	<!--分享-->
		<div id="index_share" class="mui-popover mui-popover-action mui-popover-bottom">
			<div align="center">
				<div>
					<i class="iconfont icon-weixin"></i><br />
					<span>微信好友</span>
				</div>
				<div>
					<i class="iconfont icon-pengyouquan"></i><br />
					<span>朋友圈</span>
				</div>
				<div>
					<i class="iconfont icon-link"></i><br />
					<span>复制链接</span>
				</div>
				<div>
					<i class="iconfont icon-qq"></i><br />
					<span>QQ好友</span>
				</div>
			</div>
			<div class="mui-content-padded" align="center">
				<div>
					<button type="button" class="mui-btn mui-btn-grey" id="cancelShare">取消</button>
				</div>
			</div>
		</div>
	<!--邀请朋友-->
		<div id="index_invite" class="mui-popover mui-popover-action mui-popover-bottom">
			<div align="center">
				<div id="weichatFriends">
					<i class="iconfont icon-weixin"></i><br />
					<span>微信好友</span>
				</div>
				<div id="weiboFriends">
					<i class="iconfont icon-weibo"></i><br />
					<span>微博好友</span>
				</div>
				<div id="qqFriends">
					<i class="iconfont icon-qq"></i><br />
					<span>QQ好友</span>
				</div>
			</div>
			<div class="mui-content-padded" align="center">
				<div>
					<button type="button" class="mui-btn mui-btn-grey" id="cancelInvite">取消</button>
				</div>
			</div>
		</div>
	
					
	<div id="gonggaolan" class="mui-popover" >
			<div class="mui-row" >
					<div class="mui-col-sm-12 mui-col-xs-12">
						<h4 id="h4"> <i class="mui-icon iconfont icon-gonggao1" style="max-height:50%;overflow:hidden;font-size:2rem;transform: rotate(15deg);margin-left:-0.2rem;"></i> 公告</h4>
						
						<div class="gonggao-text" id="gonggao_text" >公告内容 公告内容容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内容 公告内
					</div>
					
				</div>
		</div>
		<div class="mui-row" style="text-align: center;">
						<button class="mui-btn" id="btn_close">关闭</button>
					</div>
	</div>
	
</body> 
</html>
</script>
<script type="text/javascript">
	mui.init({
		keyEventBind: {
			backbutton: true
		}
	});
var tasks = "";
var u = localStorage.getItem("user");
mui.plusReady(function() {
	mui.back = function() {
		mui.confirm('确定退出应用?', '警告', function(e) {
			if(e.index == 1) {
				plus.runtime.quit();
			}
		}, 'div');
	}
	//判断网络是否连接
	window.net = plus.networkinfo.getCurrentType();
	window.addEventListener('refresh', function(e) { //执行刷新
		location.reload();
	});
	plus.geolocation.getCurrentPosition(translatePoint,function(e){  
        mui.toast("获取地址异常:" + e.message);  
   }); 
	//点击主按钮，显示或隐藏菜单
	var sh = document.getElementById("mune-son");
	document.getElementById("mainBtn").addEventListener("tap", function() {
		if(sh.classList.contains("hide")) {
			sh.classList.remove("hide");
			sh.classList.add("show");
			this.classList.remove("icon-jiahao2");
			this.classList.add("icon-error");
		} else {
			sh.classList.remove("show");
			sh.classList.add("hide");
			this.classList.remove("icon-error");
			this.classList.add("icon-jiahao2");
		}
	});
	
	//个人中心
	document.getElementById("myCenter").addEventListener("tap", function() {
		sh.classList.add("hide");
		document.getElementById("mainBtn").classList.remove("icon-error");
		document.getElementById("mainBtn").classList.add("icon-jiahao2");
		if(u == null) {
			mui.confirm('您还未登录，是否立即登录?', '小提示', ['是', '否'], function(e) {
				if(e.index == 0) {
					mui.openWindow({
						url: 'login.html',
						id: 'login'
					});
				}
			}, 'div');
		} else {
			mui.openWindow({
				url: 'myCenter.html',
				id: 'myCenter',
				extras: {
					user: u
				}
			});
		}
	});
	//任务进度
	document.getElementById("taskPro").addEventListener("tap", function() {
		sh.classList.add("hide");
		document.getElementById("mainBtn").classList.remove("icon-error");
		document.getElementById("mainBtn").classList.add("icon-jiahao2");
		if(net == 1) {
			mui.toast("请检查网络连接", {
				duration: 'short',
				type: 'div'
			});
		} else if(u == null) {
			mui.confirm('您还未登录，是否立即登录?', '小提示', ['是', '否'], function(e) {
				if(e.index == 0) {
					mui.openWindow({
						url: 'login.html',
						id: 'login'
					});
				}
			}, 'div');
		} else {
			mui.openWindow({
				url: 'task/taskProgress.html',
				id: 'taskProgress',
				extras: {
					me: u
				}
			});
		}
	});
	//发布任务
	document.getElementById("publishTask").addEventListener("tap", function() {
		sh.classList.add("hide");
		document.getElementById("mainBtn").classList.remove("icon-error");
		document.getElementById("mainBtn").classList.add("icon-jiahao2");
		if(u == null) {
			mui.confirm('您还未登录，是否立即登录?', '小提示', ['是', '否'], function(e) {
				if(e.index == 0) {
					mui.openWindow({
						url: 'login.html',
						id: 'login'
					});
				}
			}, 'div');
		} else {
			mui.ajax({
				url:'http://47.96.156.75/public/index/user/getuserdata',
				type:'post',
				data:{
					phone:u
				},
				dataType:'json',
				header:{'Content-Type':'application/json'},
				async:false,
				timeout:5000,
				success:function(data){
					d = JSON.parse(data);
					if(d[0].idstate == '已认证'){
						mui.openWindow({
							url: 'publishTask.html',
							id: 'publishTask',
							extras: {
								user:u
							}
						});
					}else if(d[0].idstate == '待审核'){
						mui.openWindow({
							url: 'waiting.html',
							id: 'waiting'
						});
					}
				     else if(d[0].nickname == null || d[0].nickname == ''){
				     	mui.confirm('您还未没有用户名，是否立即编辑?', '小提示', ['是', '否'], function(e) {
							if(e.index == 0) {
								mui.openWindow({
									url: 'editInformation.html',
									id: 'editinformation'
								});
							}
						}, 'div');
				     }
					else{
						mui.openWindow({
							url: 'publishTask.html',
							id: 'publishTask',
							extras: {
								user:u
							}
						});
					}
					plus.nativeUI.closeWaiting();
				},
				error:function(xhr,type,errorThrown){
					mui.toast('异常:'+errorThrown);
				}
			});
		}
		
		
		
	});
		

	//打开分享
	document.getElementById("share").addEventListener("tap",function(){
		mui("#index_share").popover("show",document.getElementById("index_share"));
	});
	//关闭分享
	document.getElementById("cancelShare").addEventListener("tap",function(){
		mui("#index_share").popover("hide");
	});

	//手动定位
	document.getElementById("handPosition").addEventListener("tap",function(){
		plus.geolocation.getCurrentPosition(translatePoint,function(e){  
	        mui.toast("手动定位异常:" + e.message);  
	   });
	});
	//邀请朋友
	document.getElementById("inviteFriend").addEventListener("tap",function(){
		mui('#index_invite').popover('show',document.getElementById("index_invite"));
	});
	//关闭邀请朋友
	document.getElementById("cancelInvite").addEventListener("tap",function(){
		mui('#index_invite').popover('hide');
	});
	//微信好友，检测用户是否安装了微信
	document.getElementById("weichatFriends").addEventListener("tap",function(){
		try {
			var packageName = 'com.tencent.mm';//微信的包名
			        var main = plus.android.runtimeMainActivity();
			        var packageManager = main.getPackageManager();
			        var PackageManager = plus.android.importClass(packageManager);
			        var packageInfo = packageManager.getPackageInfo(packageName, PackageManager.GET_ACTIVITIES);
			        if (packageInfo) {
						alert('已安装');
			        } else {
						alert('未安装');
			        }
			    } catch (e) {
						alert('未安装');
			}
	});
	//qq好友。检测
	document.getElementById("qqFriends").addEventListener("tap",function(){
		try {
			var packageName = 'com.tencent.mobileqq';//qq的包名
			        var main = plus.android.runtimeMainActivity();
			        var packageManager = main.getPackageManager();
			        var PackageManager = plus.android.importClass(packageManager);
			        var packageInfo = packageManager.getPackageInfo(packageName, PackageManager.GET_ACTIVITIES);
			        if (packageInfo) {
						alert('已安装');
			        } else {
						alert('未安装');
			        }
			    } catch (e) {
						alert('未安装');
			}
	});
	//微博好友。检测
	document.getElementById("weiboFriends").addEventListener("tap",function(){
		try {
			var packageName = 'com.sina.weibo';//微博的包名
			        var main = plus.android.runtimeMainActivity();
			        var packageManager = main.getPackageManager();
			        var PackageManager = plus.android.importClass(packageManager);
			        var packageInfo = packageManager.getPackageInfo(packageName, PackageManager.GET_ACTIVITIES);
			        if (packageInfo) {
						alert('已安装');
			        } else {
						alert('未安装');
			        }
			    } catch (e) {
						alert('未安装');
			}
	});
	
	
	//任务记录
	document.getElementById("myHongbao").addEventListener("tap",function(){
		mui.openWindow({
			url:'taskLog.html',
			id:'taskLog'
		});
	});
	//定位菜单栏打开任务进度
	document.getElementById("taskProgress").addEventListener("tap",function(){
		if(net == 1) {
			mui.toast("请检查网络连接", {
				duration: 'short',
				type: 'div'
			});
		} else if(u == null) {
			mui.confirm('您还未登录，是否立即登录?', '小提示', ['是', '否'], function(e) {
				if(e.index == 0) {
					mui.openWindow({
						url: 'login.html',
						id: 'login'
					});
				}
			}, 'div');
		} else {
			mui.openWindow({
				url: 'task/taskProgress.html',
				id: 'taskProgress',
				extras: {
					me: u
				}
			});
		}
	});
	
	
	//加载函数
	getTaskData();
	//获取存入本地的用户数据
	//window.userId = localStorage.getItem("userId");
	document.addEventListener("netchange", function() {
		var nt = plus.networkinfo.getCurrentType();
		switch(nt) {
			case plus.networkinfo.CONNECTION_ETHERNET:
			case plus.networkinfo.CONNECTION_WIFI:
				getTaskData();
				mui.toast("已切换至wifi");
				break;
			case plus.networkinfo.CONNECTION_CELL2G:
			case plus.networkinfo.CONNECTION_CELL3G:
			case plus.networkinfo.CONNECTION_CELL4G:
				getTaskData();
				mui.toast("已切换至数据流量");
				break;
			default:
				mui.toast("请检查网络连接");
				break;
		}
	}, false);
	//setInterval("autoLocation();",1000);
});
//loadMaps();
function getTaskData() {
	//异步请求数据,返回数据数量
	mui.ajax({
		url: 'http://47.96.156.75/public/index/task/getalltask',
		type: 'post',
		dataType: 'json',
		async: false,
		header: {
			'Content-Type': 'application/json'
		},
		success: function(data) {
			//alert(data);
			tasks = JSON.parse(data);
			if(tasks.code == 200) {
				//loadMaps();
				mui.toast('共找到' + tasks.datas.length + '个任务');
			} else if(tasks.code == 202) {
				//loadMaps();
				mui.toast('共找到0个任务');
			} else {
				mui.toast('查找失败');
			}
		},
		error: function(xhr, type, errorThrown) {
			mui.toast('错误', errorThrown);
		}
	});
}



	// 百度地图API功能
	/*var map = new BMap.Map("allmap", {
		enableHighResolution: true //是否开启高清   
	});
	// 创建Map实例
	var point = new BMap.Point(106.63658, 26.653324);
	map.centerAndZoom(point, 16); // 初始化地图,设置中心点坐标和地图级别
	map.setMapType(BMAP_PERSPECTIVE_MAP);     //修改地图类型为3D地图  
	map.setCurrentCity("贵阳"); // 设置地图显示的城市 此项是必须设置的
	map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
	map.enableInertialDragging();
	map.enableContinuousZoom();*/
	var myIcon = new BMap.Icon("icon/tasks.svg", new BMap.Size(64,124));
	var myP = new BMap.Icon("icon/here.svg", new BMap.Size(115,64)); 
	//var geolocation = new BMap.Geolocation();
/*function autoLocation(){
	plus.geolocation.getCurrentPosition(translatePoint,function(e){  
        mui.toast("异常:" + e.message);  
   }); 
  }*/
	/*geolocation.getCurrentPosition(function(result) {
		var marker;
		if(this.getStatus() == BMAP_STATUS_SUCCESS){
			map.removeOverlay(marker);    
			for(var i = 0; i < tasks.datas.length; i++) {
				var point = new BMap.Point(tasks.datas[i].task_getlng, tasks.datas[i].task_getlat);
				marker = new BMap.Marker(point, {
					icon: myIcon
				}); // 创建标注
				marker.disableDragging(); // 不可拖拽
				map.addOverlay(marker); // 将标注添加到地图中
				marker.setTitle(tasks.datas[i].id);
				marker.addEventListener("click", getTask);
			}
			//marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
			latitude = result.point.lat; //获取到的纬度  
			longitude = result.point.lng; //获取到的经度  
			//定位我的位置
			map.panTo(result.point);
			var geoc = new BMap.Geocoder();　
			var pt = new BMap.Point(longitude, latitude); //实例化这两个点	
				geoc.getLocation(pt, function(r) {
				//定位  
				var myPosition = new BMap.Marker(new BMap.Point(result.point.lng, result.point.lat),{icon:myP});
				map.addOverlay(myPosition);
				//myPosition.setAnimation(BMAP_ANIMATION_DROP); //跳动的动画
				var addComp = r.addressComponents;
				var address = '';
				address += addComp.province;
				address += addComp.city;
				address += addComp.district;
				address += addComp.street;
				address += addComp.streetNumber;
				//speak("已定位到您当前位置:" + address);
				//mui.toast("已定位到您当前位置:"+address,{ duration:'short', type:'div' });
			});
		} else {
			mui.toast('定位失败' + this.getStatus());
		}
	}, {
		enableHighAccuracy: true
	});*/
//}
//当前位置  
	function translatePoint(position) {
		mui.toast('定位中...');
        var currentLon = position.coords.longitude;
        var currentLat = position.coords.latitude;
        var gpsPoint = new BMap.Point(currentLon, currentLat);
        BMap.Convertor.translate(gpsPoint, 2, initMap); //坐标转换
    }
    function initMap(point) {
        map = new BMap.Map("allmap", {
			enableHighResolution: true //是否开启高清   
		}); //创建地图
        map.addControl(new BMap.ScaleControl());
        map.addControl(new BMap.OverviewMapControl());
        map.centerAndZoom(point, 18);
        map.enableInertialDragging();
		map.enableContinuousZoom();
        map.addOverlay(new BMap.Marker(point, {
					icon: myP
			}));
		var marker;
		map.removeOverlay(marker);    
			for(var i = 0; i < tasks.datas.length; i++) {
				var point = new BMap.Point(tasks.datas[i].task_getlng, tasks.datas[i].task_getlat);
				marker = new BMap.Marker(point, {
					icon: myIcon
				}); // 创建标注
				marker.disableDragging(); // 不可拖拽
				map.addOverlay(marker); // 将标注添加到地图中
				marker.setTitle(tasks.datas[i].id);
				marker.addEventListener("click", getTask);
			}
    }
function getTask() {
	//打开详情界面
	if(u == null) {
			mui.confirm('您还未登录，是否立即登录?', '小提示', ['是', '否'], function(e) {
				if(e.index == 0) {
					mui.openWindow({
						url: 'login.html',
						id: 'login'
					});
				}
			}, 'div');
	}else{
		for(var i = 0; i < tasks.datas.length; i++) {
			if(tasks.datas[i].task_user == u) {
				mui.openWindow({
					url: 'task/myPublished.html',
					id: 'myPublished',
					extras: {
						u: tasks.datas[i].id
					}
				});
				break;
			} else {
				if(tasks.datas[i].id == this.getTitle()) { //alert(tasks.datas[i].task_user);
					mui.openWindow({
						url: 'getTask.html',
						id: 'getTask',
						extras: {
							task_id: tasks.datas[i].id,
							task_title: tasks.datas[i].task_title,
							task_money: tasks.datas[i].task_money,
							task_startTime: tasks.datas[i].task_start_time,
							task_endTime: tasks.datas[i].task_end_time,
							task_per: tasks.datas[i].task_voild,
							task_getPlace: tasks.datas[i].task_get_location,
							task_connetPlace: tasks.datas[i].task_connet_location,
							task_details: tasks.datas[i].task_details,
							task_getLng: tasks.datas[i].task_getlng, //获取任务领取点的经度
							task_getLat: tasks.datas[i].task_getlat, //获取任务领取点的纬度
							task_connetLng: tasks.datas[i].task_connetlng, //获取任务交接点的经度
							task_connetLat: tasks.datas[i].task_connetlat, //获取任务领取点的纬度
							task_user: tasks.datas[i].task_user //获取发布用户
						}
					});
					break;
				}
			}
		}
	}
}
function loadMaps() { //语音
	//speak("正在获取当前位置，请稍等");
	mui.toast('获取位置中...');
/*	autoLocation();*/
	var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
		scale: 0.6, //图标缩放大小
		strokeColor: '#fff', //设置矢量图标的线填充颜色
		strokeWeight: '2', //设置线宽
	});
	var icons = new BMap.IconSequence(sy, '10', '30');
	// 创建polyline对象
	var pois = [
		new BMap.Point(116.350658, 39.938285),
		new BMap.Point(116.386446, 39.939281),
		new BMap.Point(116.389034, 39.913828),
		new BMap.Point(116.442501, 39.914603)
	];
	var polyline = new BMap.Polyline(pois, {
		enableEditing: false, //是否启用线编辑，默认为false
		enableClicking: true, //是否响应点击事件，默认为true
		icons: [icons],
		strokeWeight: '8', //折线的宽度，以像素为单位
		strokeOpacity: 0.8, //折线的透明度，取值范围0 - 1
		strokeColor: "#18a45b" //折线颜色
	});
	map.addOverlay(polyline); //增加折线
}

	
	//打开公告
	document.getElementById("gonggao").addEventListener("tap",function(){
		mui("#gonggaolan").popover("show",document.getElementById("gonggaolan"));
		//请求公告信息并渲染
		mui.ajax({
			url: 'http://47.96.156.75/public/index/Description/selectRelease',
			type: 'post',
			dataType: 'json',
			async: true,
			header: {
				'Content-Type': 'application/json'
			},
			success: function(data) {
				//alert(data);
				d = JSON.parse(data);
			    //  alert(d.data[0].text_content);
				document.getElementById("gonggao_text").innerHTML = d.data[0].text_content
				
			},
			error: function(xhr, type, errorThrown) {
				mui.toast('请求小喇叭数据发生错误', type);
			}
		});
		
	});

	//关闭公告
	document.getElementById("btn_close").addEventListener("tap",function(){
		mui("#gonggaolan").popover("hide");
	});
	
	//打开活动
	document.getElementById("taskActivity").addEventListener("tap",function(){
		mui.openWindow({
			url:'shopping/list.html',
		})
    });

	
	
</script>
<script type="text/javascript">
	$(function(){
		//异步请求数据,返回最新动态数据
		mui.ajax({
			url: 'http://47.96.156.75/public/index/task/getnews',
			type: 'post',
			dataType: 'json',
			async: true,
			header: {
				'Content-Type': 'application/json'
			},
			success: function(data) {
				//alert(data);
				news = JSON.parse(data);
				var strs = "";
				var before = "";
				var after = "";
				for(var i = 0; i < news.length; i++){
					var s = news[i].task_user;
					before = s.substring(0,3);
					after = s.substring(7,11);
					strs += "<a style='color:black; font-weight:bold; margin-left:5px;'>"+before+"****"+after+"用户发布了"+news[i].task_title+"任务</a>";
				}
				document.getElementById("scroll_div").innerHTML = strs;
				$('#scroll_div').liMarquee();
				
				
				
			},
			error: function(xhr, type, errorThrown) {
				mui.toast('错误', type);
			}
		});
		
		
		
	});
</script>
